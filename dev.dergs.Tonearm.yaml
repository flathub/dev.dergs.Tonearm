app-id: dev.dergs.Tonearm
runtime: org.gnome.Platform
runtime-version: "49"
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.golang
command: tonearm

finish-args:
  - --share=network # Needs network access since it is a music streaming application
  - --share=ipc # Share IPC namespace with the host (necessary for X11).
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio # Needs access to pulseaudio for audio output. (Input is not used)
  - --device=dri # OpenGL rendering support.

build-options:
  env:
    - GOBIN=/app/bin
    - GOROOT=/usr/lib/sdk/golang

modules:
  - name: tonearm
    buildsystem: simple
    build-commands:
      - $GOROOT/bin/go build -ldflags="-X codeberg.org/dergs/tonearm/internal/ui.Commit=$(git describe --tags --long --abbrev=7 2>/dev/null || git rev-parse HEAD 2>/dev/null) -w -s" -gcflags=all=-l -trimpath -o tonearm cmd/tonearm/main.go
      - install -Dm00755 tonearm $FLATPAK_DEST/bin/tonearm
      - install -Dm00644 internal/icons/hicolor/scalable/apps/$FLATPAK_ID.svg $FLATPAK_DEST/share/icons/hicolor/scalable/apps/$FLATPAK_ID.svg
      - install -Dm00644 internal/icons/hicolor/symbolic/apps/$FLATPAK_ID-symbolic.svg $FLATPAK_DEST/share/icons/hicolor/symbolic/apps/$FLATPAK_ID-symbolic.svg
      - install -Dm00644 build/$FLATPAK_ID.desktop $FLATPAK_DEST/share/applications/$FLATPAK_ID.desktop
      - install -Dm00644 build/$FLATPAK_ID.metainfo.xml $FLATPAK_DEST/share/metainfo/$FLATPAK_ID.metainfo.xml
      - install -Dm00644 internal/settings/$FLATPAK_ID.gschema.xml $FLATPAK_DEST/share/glib-2.0/schemas/$FLATPAK_ID.gschema.xml
      - glib-compile-schemas $FLATPAK_DEST/share/glib-2.0/schemas
    sources:
      - go.mod.yml
      - type: git
        url: https://codeberg.org/dergs/Tonearm.git
        tag: v1.0.0
